
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LaBaties Editor — Phase 1</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="LaBaties Editor">
  <style>
    :root{
      --bg:#0f1115;--panel:#171a21;--text:#e8e8ea;--muted:#a8abb2;--accent:#6aa9ff;--border:#242a33;
      --gap:14px;--pad:14px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font-family:-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji}
    .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
    header,footer{padding:var(--pad);background:var(--panel);border-bottom:1px solid var(--border)}
    footer{border-top:1px solid var(--border);border-bottom:none}
    .content{display:grid;gap:var(--gap);grid-template-columns:1fr; padding:var(--pad)}
    @media(min-width:980px){.content{grid-template-columns:340px 1fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:var(--pad)}
    .controls{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    label{font-size:14px;color:var(--muted)}
    output{min-width:60px;text-align:right}
    .slider{-webkit-appearance:none;appearance:none;width:100%;height:6px;border-radius:999px;background:#2a2f39}
    .slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--accent);border:none;box-shadow:0 0 0 4px rgba(106,169,255,.15)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#1d232d;color:var(--text);font-weight:600;cursor:pointer}
    .btn.primary{background:var(--accent);color:#0a0f1a}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px}
    .hint{font-size:12px;color:var(--muted)}
    .canvas-wrap{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:repeating-conic-gradient(#1e232c 0% 25%, #1a1f27 0% 50%) 50%/22px 22px;min-height:320px}
    canvas{width:100%;height:100%;display:block;background:transparent}
    .file{display:grid;gap:8px;margin-bottom:8px}
    .title{font-weight:700;letter-spacing:.02em}
  </style>
</head>
<body>
  <div class="app">
    <header class="title">LaBaties Editor — Phase 1</header>

    <div class="content">
      <div class="card">
        <div class="file">
          <label class="btn">
            <input id="file" type="file" accept="image/*" hidden>
            Upload image
          </label>
          <div id="status" class="hint">No image loaded.</div>
        </div>

        <div class="controls">
          <div class="row"><label>Rotate (°)</label><output id="o-rot">0</output></div>
          <input id="rot" class="slider" type="range" min="-45" max="45" step="0.1" value="0">

          <div class="row"><label>Skew X (°)</label><output id="o-skx">0</output></div>
          <input id="skx" class="slider" type="range" min="-30" max="30" step="0.1" value="0">

          <div class="row"><label>Skew Y (°)</label><output id="o-sky">0</output></div>
          <input id="sky" class="slider" type="range" min="-30" max="30" step="0.1" value="0">

          <div class="row"><label>Scale</label><output id="o-scl">1.00</output></div>
          <input id="scl" class="slider" type="range" min="0.2" max="2.5" step="0.01" value="1">

          <div class="row"><label>Offset X (px)</label><output id="o-tx">0</output></div>
          <input id="tx" class="slider" type="range" min="-2000" max="2000" step="1" value="0">

          <div class="row"><label>Offset Y (px)</label><output id="o-ty">0</output></div>
          <input id="ty" class="slider" type="range" min="-2000" max="2000" step="1" value="0">

          <div class="row"><label>Crop Width (px)</label><output id="o-cw">1600</output></div>
          <input id="cw" class="slider" type="range" min="256" max="4096" step="1" value="1600">

          <div class="row"><label>Crop Height (px)</label><output id="o-ch">2200</output></div>
          <input id="ch" class="slider" type="range" min="256" max="4096" step="1" value="2200">

          <div class="hint">Tip: For a “door open” look, try Skew X ≈ 12° and a small Rotate ≈ −4°.</div>
        </div>
      </div>

      <div class="canvas-wrap card">
        <canvas id="canvas" width="1600" height="2200" aria-label="Output canvas"></canvas>
      </div>
    </div>

    <footer class="toolbar">
      <button id="reset" class="btn">Reset</button>
      <button id="center" class="btn">Center Image</button>
      <button id="export" class="btn primary" disabled>Export PNG</button>
      <button id="share" class="btn" disabled>Share…</button>
      <span class="hint">Sharing uses your device’s share sheet (iOS/Android). For direct IG/FB APIs, we’d add a small backend later.</span>
    </footer>
  </div>

  <script>
    let img=null, imgLoaded=false;
    const $=id=>document.getElementById(id);
    const canvas=$("canvas");
    const ctx=canvas.getContext("2d",{willReadFrequently:true});

    const controls={rot:$("rot"),skx:$("skx"),sky:$("sky"),scl:$("scl"),tx:$("tx"),ty:$("ty"),cw:$("cw"),ch:$("ch")};
    const outs={rot:$("o-rot"),skx:$("o-skx"),sky:$("o-sky"),scl:$("o-scl"),tx:$("o-tx"),ty:$("o-ty"),cw:$("o-cw"),ch:$("o-ch")};

    function deg(v){return v*Math.PI/180}

    function draw(){
      const cw=parseInt(controls.cw.value,10);
      const ch=parseInt(controls.ch.value,10);
      if(canvas.width!==cw) canvas.width=cw;
      if(canvas.height!==ch) canvas.height=ch;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(!imgLoaded) return;

      const rot=deg(parseFloat(controls.rot.value));
      const skx=deg(parseFloat(controls.skx.value));
      const sky=deg(parseFloat(controls.sky.value));
      const scl=parseFloat(controls.scl.value);
      const tx=parseFloat(controls.tx.value);
      const ty=parseFloat(controls.ty.value);

      const cos=Math.cos(rot), sin=Math.sin(rot);
      const tanx=Math.tan(skx), tany=Math.tan(sky);

      let a=scl*cos, b=scl*sin, c=-scl*sin, d=scl*cos;
      const a2=a + b*tany;
      const b2=a*tanx + b;
      const c2=c + d*tany;
      const d2=c*tanx + d;

      ctx.setTransform(a2,b2,c2,d2, canvas.width/2 + tx, canvas.height/2 + ty);
      const iw=img.width, ih=img.height;
      ctx.drawImage(img, -iw/2, -ih/2);
      ctx.setTransform(1,0,0,1,0,0);

      outs.rot.value=controls.rot.value;
      outs.skx.value=controls.skx.value;
      outs.sky.value=controls.sky.value;
      outs.scl.value=parseFloat(controls.scl.value).toFixed(2);
      outs.tx.value=controls.tx.value;
      outs.ty.value=controls.ty.value;
      outs.cw.value=controls.cw.value;
      outs.ch.value=controls.ch.value;
    }

    function centerImage(){
      if(!imgLoaded) return;
      controls.tx.value=0;
      controls.ty.value=0;
      const fit=Math.min(canvas.width/img.width, canvas.height/img.height)*0.9;
      controls.scl.value=Math.max(0.01, Math.min(2.5, fit));
      controls.rot.value=0; controls.skx.value=0; controls.sky.value=0;
      draw();
    }

    function handleFile(file){
      const status=$("status");
      if(!file) return;
      status.textContent="Loading image…";
      const url=URL.createObjectURL(file);
      const im=new Image();
      im.onload=()=>{
        img=im; imgLoaded=true;
        $("export").disabled=false;
        $("share").disabled=false;
        status.textContent=`Loaded: ${file.name} (${img.width}×${img.height})`;
        centerImage();
        URL.revokeObjectURL(url);
      };
      im.onerror=()=>{
        imgLoaded=false;
        $("export").disabled=true;
        $("share").disabled=true;
        status.textContent="Couldn’t load that file. Try saving it as PNG or JPEG and re-import.";
      };
      im.src=url;
    }

    $("file").addEventListener("change",(e)=>handleFile(e.target.files[0]));

    Object.values(controls).forEach(input=>{
      input.addEventListener("input", draw, {passive:true});
      input.addEventListener("change", draw);
    });

    $("reset").addEventListener("click",()=>{
      if(!imgLoaded) return;
      controls.rot.value=0;controls.skx.value=0;controls.sky.value=0;
      controls.scl.value=1;controls.tx.value=0;controls.ty.value=0;
      draw();
    });
    $("center").addEventListener("click", centerImage);

    $("export").addEventListener("click",()=>{
      const link=document.createElement("a");
      link.download="labaties-edit.png";
      link.href=canvas.toDataURL("image/png");
      link.click();
    });

    // Basic Share Sheet (iOS/Android, HTTPS required when hosted)
    $("share").addEventListener("click", async ()=>{
      try{
        canvas.toBlob(async (blob)=>{
          if(!blob){ alert("Export failed. Try Export PNG instead."); return; }
          const file=new File([blob], "labaties-edit.png", {type:"image/png"});
          if(navigator.canShare && navigator.canShare({files:[file]})){
            await navigator.share({files:[file], title:"LaBaties Edit", text:"Edited with LaBaties Editor"});
          }else{
            alert("Your browser doesn’t support direct sharing. Use Export PNG and post via your app.");
          }
        },"image/png");
      }catch(e){
        alert("Share failed: "+e.message);
      }
    });

    // First paint
    draw();
  </script>
</body>
</html>
